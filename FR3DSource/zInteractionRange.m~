% zSimpleSecondaryStructure(File) returns a sparse matrix S which indicates
% how far a pairwise interaction is from being a local interaction

function [S] = zSimpleSecondaryStructure(File, Verbose)

C = fix(abs(File.Edge))+100*(fix(abs(File.BasePhosphate+File.BasePhosphate')));

if Verbose > 1,
  figure(1)
  clf
  spy(C);
  title('Locations of pairwise interactions of all types');
end

C = triu(C);                % sparse matrix of pairwise interactions

[i,j,c] = find(C);          % locations of all pairwise interactions

k = find((j > i));          % ignore self interactions

i = i(k);
j = j(k);
c = c(k);

[y,k] = sort(j-i);          % order by distance from diagonal

i = i(k);
j = j(k);
c = c(k);

d = zeros(size(c));                              % current distance from local

for m = 1:length(i),
  if (c(m) == 1) && (d(m) <= 10),                % pair, not pseudoknot
    p =     (i <= i(m)) .* (j >= i(m)) .* (j <= j(m));
    p = p + (i >= i(m)) .* (i <= j(m)) .* (j >= j(m));
    q = find(p);

    if c(m) == 1,
      a = 1;                           % record Manhattan distance to i(m),j(m)
    else
      a = 0.5;                         % use half the distance
    end

    d(q) = max(d(q), a*(abs(i(m)-i(q))+abs(j(m)-j(q))));

    if Verbose > 2,
      figure(2)
      clf
      plot(j(q),i(q),'.');
      hold on
      plot(j(m),i(m),'r.');
      axis([1 max(i) 1 max(i)]);
      axis ij
      drawnow
      if Verbose > 3,
        pause
      end
    end

  end
end

i = [i; length(File.NT)];
j = [j; length(File.NT)];
d = [d; 0];
c = [c; 0];

if Verbose > 1,
  figure(3)
  clf
  S = sparse(i,j,d+1);
  S = S + S';
  spy((S > 0) .* (S <=10))
  title('Local pairing interactions');

  figure(4)
  clf
  q = find((c==1) .* (d >= 10));
  plot(j(q),i(q),'r.');
  hold on
  q = find((c==1) .* (d < 10));
  plot(j(q),i(q),'.');
  title('Local and long-range cWW interactions');
  axis ij

end

S = sparse(i,j,d);
S = S + S';

if Verbose > 0,
  fprintf('%s has %d basepairs, of which %d are local.\n', File.Filename, full(sum(sum((C > 0) .* (C < 15)))), full(sum(sum(((S<=10).*C > 0) .* ((S<=10).*C < 15)))));
  for m = 1:15,
    all = length(find(c==m));
    local = length(find((c==m).*(d<=10)));
    longrange = all - local;
    fprintf('%4s %3d total, %3d local, %3d long-range\n', zEdgeText(m), all, local, longrange);
  end

  fprintf('Long-range cWW interactions:\n');
  q = find((c==1).*(d>10));
  for m = 1:length(q),
    fprintf('%s%s with %s%s\n', File.NT(i(q(m))).Base,File.NT(i(q(m))).Number, File.NT(j(q(m))).Base, File.NT(j(q(m))).Number);
  end
end

% Statistics for 2avy with depth 10:

%Originally  678 basepairs
%At the end, 577 basepairs
%cWw  original 472 final 460
%tWw  original   7 final   6
%cWH  original  12 final   5
%tWH  original  33 final  32
%cWS  original  12 final   8
%tWS  original   9 final   6
%cHH  original   0 final   0
%tHH  original   3 final   2
%cHS  original   7 final   4
%tHS  original  44 final  40
%cSs  original  45 final   7
%tSs  original  27 final   5
%bif  original   3 final   2
%Rib  original   4 final   0
%  -  original   0 final   0